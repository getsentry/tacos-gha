#!/bin/bash
set -euo pipefail
export TERRAGRUNT_INCLUDE_MODULE_PREFIX=false

if ! [[ "$GITHUB_PR_APPROVERS" ]]; then
    : no approvers! bail.
    gha-step-summary >/dev/null <<EOF
### TACOS Apply: $TF_ROOT_MODULE

Production changes must be peer-reviewed.
Please try again after code review.

Apply request refused: PR has no approvals
EOF
    exit 1
fi

cmd=(
  env GETSENTRY_SAC_VERB=apply
  sudo-gcp
  tf-lock
  ci-tf-init
  ci-tf-refresh
  terragrunt-noninteractive run-all
    apply --auto-approve
)

exec tf-step-summary "TACOS Apply" "${cmd[@]}" <<EOF

Approvers: $GITHUB_PR_APPROVERS
EOF
