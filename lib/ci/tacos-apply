#!/bin/bash
set -euo pipefail
export TERRAGRUNT_INCLUDE_MODULE_PREFIX=false
cmd=(tf-lock terragrunt-noninteractive apply --auto-approve)
log=apply-log.hcl

if ! [[ "$GITHUB_PR_APPROVERS" ]]; then
    gha-step-summary <<EOF
### TACOS Apply: $TF_ROOT_MODULE
Production changes must be peer-reviewed.
Please try again after code review.

Apply request refused: PR has no approvals
EOF
    exit 1
fi

set -x
"${cmd[@]}" 2>&1 | tee "$log" && status=$? || status=$?

summary="$(
  if ! tac "$log" | grep -Ei -m1 'complete|error'; then
    echo "summary failed!($?)"
  fi
)"

# note: this renders twice: step summary in GHA, and comment in PR
gha-step-summary <<EOF
### TACOS Apply: $TF_ROOT_MODULE

approvers: $GITHUB_PR_APPROVERS

<details>
  <summary>$summary</summary>

\`\`\`console
$ cd $(sh-quote "$TF_ROOT_MODULE")
$ $(sh-quote "${cmd[@]}")
\`\`\`

\`\`\`hcl
$(cat apply-log.hcl)
\`\`\`

</details>
EOF

exit "$status"
