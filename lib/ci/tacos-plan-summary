#!/usr/bin/env python3
from __future__ import annotations

from typing import NamedTuple
from typing import Self

from lib.sh import sh
from lib.types import Generator
from lib.types import OSPath

ExitCode = None | str | int
Line = str


def get_file(path: OSPath) -> str:
    return path.read_text().strip()


class SliceSummary(NamedTuple):
    name: str
    path: OSPath
    tacos_verb: str
    explanation: str
    returncode: int

    @classmethod
    def from_matrix_fan_out(cls, path: OSPath) -> Self:
        # convert a bunch of files into something well-typed
        return cls(
            name=get_file(path / "env/TF_ROOT_MODULE"),
            path=path,
            tacos_verb=get_file(path / "tacos_verb"),
            explanation=get_file(path / "explanation"),
            returncode=int(get_file(path / "returncode")),
        )

    @classmethod
    def from_matrix_fan_in(cls, path: OSPath) -> Generator[Self]:
        for matrix in (path / "matrix.list").open():
            matrix = matrix.strip()

            yield cls.from_matrix_fan_out(path / matrix)

    # see lib/ci/bin/tf-step-summary:
    @property
    def tf_log(self) -> OSPath:
        return self.path / "tf-log.hcl"

    @property
    def console_log(self) -> OSPath:
        return self.path / "console.log"

    @property
    def dirty(self) -> bool:
        return self.returncode == 2

    @property
    def clean(self) -> bool:
        return self.returncode == 0

    @property
    def error(self) -> bool:
        return self.returncode not in (0, 2)

    def summary(self) -> str:
        log = tuple(sh.lines(("uncolor", self.tf_log)))
        for line in reversed(log):
            for success in ("Apply complete", "Plan:", "No changes"):
                if success in line:
                    return line  # :D

        log = tuple(sh.lines(("uncolor", self.console_log)))
        for line in log:
            if "error" in line.lower():
                return line  # D:

        for line in reversed(log):
            lowered = line.lower()
            if "success" in lowered:
                return line  # :D
            elif "failure" in lowered:
                return line  # D:

        # we didn't find anything significant-looking at all
        return f"completed (code {self.returncode})"

    def markdown(self, rollup: bool) -> Generator[Line]:
        yield f"### {self.name}"
        yield self.explanation
        yield ""

        tf_log = sh.stdout(("uncolor", self.tf_log)).strip()

        if rollup:
            # hide boring bits
            yield "<details>"
            yield f"  <summary>{self.summary()}</summary>"
        else:
            # things failed -- show it
            yield f"  {self.summary()}"
        yield ""

        yield "  <details>"
        yield f"    <summary>Commands: (exit: {self.returncode})</summary>"
        yield ""
        yield "```console"
        yield sh.stdout(("uncolor", self.console_log)).strip()
        yield "```"
        yield ""
        yield "  </details>"
        yield ""

        yield ""
        yield "  Result:"
        yield ""
        if tf_log:
            yield "```hcl"
            yield tf_log
            yield "```"
        else:
            yield "(no output)"
        yield ""

        if rollup:
            yield "</details>"
            yield ""

        yield f'<!-- getsentry/tacos-gha "{self.tacos_verb}({self.name})" -->'
        yield ""

    def __str__(self) -> str:
        return self.name


def tacos_plan_summary(path: OSPath) -> Generator[Line]:
    slices = tuple(SliceSummary.from_matrix_fan_in(path))

    dirty = tuple(slice for slice in slices if slice.dirty)
    clean = tuple(slice for slice in slices if slice.clean)
    error = tuple(slice for slice in slices if slice.error)

    yield "# Terraform Plan"
    yield f"TACOS generated a terraform plan for {len(slices)} slices:"
    yield ""
    if error:
        yield f"  * {len(error)} failed to plan"
    if dirty:
        yield f"  * {len(dirty)} affected"
    if clean:
        yield f"  * {len(clean)} unaffected"

    first = False
    if error:
        yield "## Errors"
        yield ""
        for slice in error:
            yield from slice.markdown(rollup=not first)
            first = False

    if dirty:
        yield "## Changes"
        yield ""

        for slice in dirty:
            yield from slice.markdown(rollup=not first)
            first = False

    if clean:
        yield "## Clean"
        yield ""
        yield "These slices are in scope of your changes, but Terraform found"
        yield "no necessary changes."
        yield ""
        for slice in clean:
            yield f"  * {slice.name}"


def main() -> ExitCode:
    from sys import argv

    try:
        arg = argv[1]
    except IndexError:
        arg = "./matrix-fan-out"

    path = OSPath(arg)

    for line in tacos_plan_summary(path):
        print(line)

    return 0


if __name__ == "__main__":
    raise SystemExit(main())
