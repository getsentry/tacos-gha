#!/bin/bash
set -euo pipefail
title="$1"
script="$2"


save_var() {
  path="$1"
  var="$2"

  eval 'echo "${'"$var"':-}"' > "$path/$var"
}


tf_log=tf-log.hcl
console_log=console.log
outdir="matrix-fan-out"

tacos_verb="$(basename "$script")"
echo "# $title:"
with-user-env "$TF_ROOT_MODULE" \
  "$script" 2>&1 >"$tf_log" |
  tee "$console_log" \
  && returncode=$? \
  || returncode=$? \
;

cat "$tf_log"

mkdir "$outdir"

# save any local vars we'll need for analysis during fan-in summary
mkdir -p "$outdir/env"
for var in HOME GITHUB_WORKSPACE TF_ROOT_MODULE TACOS_LOCK; do
  save_var "$outdir/env" "$var"
done
for var in tacos_verb title script returncode; do
  save_var "$outdir" "$var"
done
cat > "$outdir/explanation"

# copy any files we want to keep
cp "$tf_log" "$console_log" "$outdir"

tree "$outdir"

if [[ "$tacos_verb" == "plan" ]] && (( returncode == 2 )); then
  # plan succeeded but found that changes need to be applied
  exit 0
else
  exit "$returncode"
fi
