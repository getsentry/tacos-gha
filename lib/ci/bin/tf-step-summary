#!/bin/bash
set -euo pipefail
title="$1"
script="$2"

save_legacy_summary() {
  explanation="$1"

  summary="$(
    if tac "$tf_log" | uncolor | grep -E -m1 '^(Apply complete|Plan:|No changes)'; then
      : :D
    elif cat "$console_log" "$tf_log" | uncolor | grep -E -m1 'error|Error|ERROR'; then
      : D:
    elif tac "$console_log" | uncolor | grep -E -m1 '(success|failure):'; then
      : /shrug
    else
      echo "completed (code $returncode)"
    fi
  )"

  if (( returncode == 0 )); then
    exit_code='success'
  else
    exit_code="error code $returncode"
  fi
  result_len=$(wc -l < "$tf_log")
  if (( returncode == 0 )); then
    rollup=true
  else
    rollup=false
  fi

  (
    echo "### $title: $TF_ROOT_MODULE"
    echo
    echo "$explanation"

    if "$rollup"; then
      # hide boring bits
      echo '<details>'
      echo "  <summary>$summary</summary>"
      echo
      echo '  <details>'
      echo "    <summary>Commands: ($exit_code)</summary>"
    else
      # things failed -- show it
      echo "  $summary"
      echo
      echo "  Commands: ($exit_code)"
    fi

    echo
    echo '```console'
    cat "$console_log"
    echo '```'

    if "$rollup"; then
      echo '</details>'
    fi

    if (( result_len > 0 )); then
      echo
      echo '  Result:'
      echo
      echo '```hcl'
      cat "$tf_log"
      echo '```'
    else
      echo '(no output)'
    fi

    if "$rollup"; then
      echo '</details>'
    fi

    echo '<!-- getsentry/tacos-gha "'"$tacos_verb($TF_ROOT_MODULE)"'" -->'
  ) |
    gha-step-summary >/dev/null
}

tf_log=tf-log.hcl
console_log=console.log

tacos_verb="$(basename "$script")"
with-user-env "$TF_ROOT_MODULE" \
  "$script" 2>&1 >"$tf_log" |
  tf-log-normalize |
  tee "$console_log" \
  && returncode=$? \
  || returncode=$? \
;

cat "$tf_log"
explanation="$(cat)"  # put any extended explanation on stdin

export DEBUG="${DEBUG:-}"
if (( DEBUG > 0 )); then
  set -x
fi
save-matrix-fan-out <<< "$explanation"
save_legacy_summary "$explanation"

if [[ "$tacos_verb" == "plan" ]] && (( returncode == 2 )); then
  # plan succeeded but found that changes need to be applied
  exit 0
else
  exit "$returncode"
fi
