#!/bin/bash
# Wrap terragrunt a little to set some CI-friendly defaults.
# We use the `terragrunt` name so that CI shows copy-pasteable commands.
# *All* settings here should represent behaviors that people "should expect" to
# change between CI and local commands.
set -euo pipefail

## Terragrunt
export TERRAGRUNT_NON_INTERACTIVE=true
# configured in tacos-gha.demo/terraform/terragrunt-base.hcl
# TODO: auto-configure terragrunt retry patterns in tacos-gha
export TERRAGRUNT_NO_AUTO_RETRY=false
# this is necessary for recursive init
export TERRAGRUNT_NO_AUTO_INIT=false
# these should *all* be IAC'd
export TERRAGRUNT_FAIL_ON_STATE_BUCKET_CREATION=true
# shown by default, but overrideable
export TERRAGRUNT_INCLUDE_MODULE_PREFIX=${TERRAGRUNT_INCLUDE_MODULE_PREFIX:-true}
# we'll be explicit
export TERRAGRUNT_NO_AUTO_APPROVE=true

# Don't try this at home, kids!
# * we use tf-lock-acquire to take the lock, before terragrunt starts
# * we run `terraform refresh` separately, in ci-tf-init
export TF_CLI_ARGS=""
export TF_CLI_ARGS_init="-lock=false"
export TF_CLI_ARGS_refresh="-lock=false -refresh=false"
export TF_CLI_ARGS_plan="-lock=false -refresh=false -detailed-exitcode"
export TF_CLI_ARGS_apply="-lock=false -refresh=false"

export DEBUG="${DEBUG:-}"
if (( DEBUG >= 1 )); then
  export TF_LOG=debug
fi
if (( DEBUG >= 4 )); then
  set -x
fi
if (( DEBUG >= 3 )); then
  export TERRAGRUNT_LOG_LEVEL=debug
elif (( DEBUG < 0 )); then
  export TERRAGRUNT_LOG_LEVEL=error
else  # 0 <= DEBUG < 3
  # NOTE: "inner" terraform errors are logged as "info"
  export TERRAGRUNT_LOG_LEVEL=info
fi

TERRAGRUNT="$(which terragrunt)"
while [[ "$TERRAGRUNT" -ef "$0" ]]; do
  TERRAGRUNT="$(super "$TERRAGRUNT")"
done

env \
  sed=>(
    sed -ur "
      # shorten terragrunt's absurdly long output, using relative paths
      s#$PWD/##g
      s#$PWD\>#.#g
      s#^\[\.\] ##  # remove any empty 'module prefix'

      # shorten terragrunt's absurdly long output, using symbolic paths
      s#$TERRAGRUNT_DOWNLOAD\>#\$TERRAGRUNT_DOWNLOAD#
      s#$REPO_ROOT\>#\$REPO_ROOT#
      s#$REPO\>#\$REPO#
      s#$HOME\>#~#
    " >&2
  ) \
  tty-attach bash -euc '
    # .. but dont separate stdout/err, unless they were already
    if [[ /dev/fd/1 -ef /dev/fd/2 ]]; then
      exec 2>"$sed" 1>&2
    else
      exec 2>"$sed"
    fi

    "$@"
  ' \
  0</dev/null \
  - \
  "$TERRAGRUNT" "$@" \
;
