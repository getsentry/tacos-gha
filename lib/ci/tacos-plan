#!/bin/bash
set -euo pipefail
export TERRAGRUNT_INCLUDE_MODULE_PREFIX=false

# TODO: let the user know who has the lock
# TODO: let the plan may not be fully accurate


cmd=(
  sudo-gcp
  tf-lock
  ci-tf-init
)

if ! "$GITHUB_PR_DRAFT"; then
  cmd=(
    # FIXME: need a lower-privilege way to enable locking
    env GETSENTRY_SAC_VERB=apply
    "${cmd[@]}"
    ci-tf-refresh
  )
fi

cmd+=(
  terragrunt-noninteractive run-all

  # terragrunt in "bare" slices will evaluate relative paths with respect to its
  # hidden terraform working directory, making the plan file hard to find, so
  # it's essential to use an absolute path here.
  plan -out "$PWD/$TF_ROOT_MODULE/tfplan"
)


gha-set-output artifact_path <<< "$TF_ROOT_MODULE/tfplan" |
  # Invalid characters include: " : < > | * ? \r \n \ /
  tr / ' ' |
  gha-set-output artifact_name \
;

exec tf-step-summary "TACOS Plan" "${cmd[@]}"
