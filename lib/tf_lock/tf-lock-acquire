#!/bin/bash
set -euo pipefail
HERE="$(cd "$(dirname "$0")"; pwd)"

# workaround, pending https://github.com/koalaman/shellcheck/issues/2899
REPO_TOP="$(cd "$HERE/../.."; pwd)"
. "$REPO_TOP/"lib/tf_lock/lib/env.sh

root_module="${1:-"."}"

if [[ "${DEBUG:-}" ]]; then
  set -x
fi

lock_info="$("$HERE/"tf-lock-info "$root_module")"
lock="$(jq .lock <<< "$lock_info")"

if "$lock"; then
  lock_user="$(jq -r .Who <<< "$lock_info")"
  tf_user="$(whoami)@$(hostname -f)"
  if [[ "$lock_user" == "$tf_user" ]]; then
    # already done!
    echo >&2 "success: acquired lock (for $lock_user): $root_module"
    "$HERE/"lib/lock-id.jq <<< "$lock_info"
    exit 0
  else
    cat >&2 <<EOF
error: lock held: $lock_user (not $tf_user): $root_module
EOF
    exit "$TF_LOCK_EHELD"
  fi
fi

( cd "$root_module"
  "$HERE/"lib/tf_lock_acquire.py
)
exec "$0" "$@"  # start over
