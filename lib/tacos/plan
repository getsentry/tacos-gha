#!/bin/bash
set -euo pipefail
# read as: cp stdout tmp && cp stderr stdout
# stdout is reserved for tf plan results
exec 3>&1 1>&2

# note: for terragrunt, tfplan must be absolute
TACOS_TFPLAN="${TACOS_TFPLAN:-$PWD/tfplan}"
TACOS_LOCK="${TACOS_LOCK:-false}"

#todo: make this an artifact instead
# we expect at most 6 slices to be fighting
git_push_aggressively() {
  sleep=3
  limit=20 # 3 min 
  while ! (set -ex; git push -q); do
    if (( sleep > limit )); then exit 1; fi
    echo "failed! trying again after $sleep seconds..."
    sleep $sleep
    (( sleep += 3 ))
    (set -ex
    git pull --rebase origin "$GITHUB_HEAD_REF" 
    )
  done
}

if "$TACOS_LOCK"; then
  ( set -ex
    env GETSENTRY_SAC_VERB=state-admin sudo-gcp tf-lock-acquire
  )
  handle-tflock-cache
fi

quietly sudo-gcp terragrunt run-all init

if "$TACOS_LOCK"; then
  quietly sudo-gcp terragrunt run-all refresh
fi

set -x
sudo-gcp terragrunt run-all plan -out "$TACOS_TFPLAN" >&3
