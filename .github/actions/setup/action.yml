name: Setup

inputs:
  shell:
    default: env ./tacos-gha/lib/ci/default-shell {0}
  ssh-private-key:
    description: "Private SSH key to use for git clone"
    type: string
    default: ""
  user:
    description: the username that will be used for following steps
    required: false
    default: ${{github.triggering_actor}}

runs:
  using: composite

  steps:
    - uses: ./tacos-gha/.github/actions/just-the-basics

    - name: tell TF username and PR
      uses: ./tacos-gha/.github/actions/set-username-and-hostname
      with:
        user: ${{inputs.user}}

    - name: set workload identity provider
      id: set-workload-identity-provider
      shell: ${{inputs.shell}}
      run: |
        "$TACOS_GHA_HOME/"lib/ci/set-workload-identity-provider

    - name: set terraformer
      id: set-terraformer
      shell: ${{inputs.shell}}
      run: |
        "$TACOS_GHA_HOME/"lib/ci/set-terraformer

    - name: gcp auth
      id: auth
      uses: google-github-actions/auth@v1
      with:
        workload_identity_provider: ${{env.GETSENTRY_SAC_OIDC}}
        service_account: ${{env.SUDO_GCP_SERVICE_ACCOUNT}}

    - name: set gcloud identity
      shell: ${{inputs.shell}}
      run: |
        # TODO: upstream feature request on google-github-actions/auth -- this
        #   should be a default behavior
        gcloud config get account || : code $?
        gcloud config set account "$SUDO_GCP_SERVICE_ACCOUNT"

        # also: mask the access token (NOTE: use cat to avoid xtrace'ing the token)
        # TODO: upstream feature request on google-github-actions/auth -- this
        #   should be a default behavior
        cat <<< "::add-mask::$(gcloud auth print-access-token)"

    # this should really be default behavior:
    - shell: ${{inputs.shell}}
      run: |
        gha-set-env 'TF_VERSION' < "$(nearest-config-file .terraform-version)"
        gha-set-env 'TERRAGRUNT_VERSION' < "$(nearest-config-file .terragrunt-version)"

    - name: Setup Terragrunt
      uses: autero1/action-terragrunt@v1.3.2
      with:
        terragrunt_version: ${{env.TERRAGRUNT_VERSION}}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_wrapper: false
        terraform_version: ${{ env.TF_VERSION }}

    - name: set $GITHUB_PR_DRAFT
      shell: ${{inputs.shell}}
      run: |
        gh pr view \
            ${{ github.event.pull_request.html_url }} \
            --json isDraft \
            --jq .isDraft |
          gha-set-env 'GITHUB_PR_DRAFT' \
        ;
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Set up SSH agent
      shell: ${{inputs.shell}}
      if: inputs.ssh-private-key != ''
      run: |
        gha-ssh-agent <<E_O_K
        ${{inputs.ssh-private-key}}
        E_O_K
